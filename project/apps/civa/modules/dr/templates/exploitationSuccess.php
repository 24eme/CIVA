<?php use_helper('Phone') ?>

<?php include_partial('dr/etapes', array('etape' => 1, 'dr' => $dr)) ?>
<?php include_partial('dr/actions', array('etape' => 1, 'help_popup_action'=>$help_popup_action)) ?>

<!-- #principal -->
<ul id="onglets_majeurs" class="clearfix">
    <li class="ui-tabs-selected"><a href="#exploitation_administratif">Administratif</a></li>
</ul>

<!-- #application_dr -->
<div id="application_dr" class="clearfix">

    <!-- #exploitation_administratif -->
    <div id="exploitation_administratif">

        <p class="intro_declaration"><?php echo acCouchdbManager::getClient('Messages')->getMessage('intro_exploitation_administratif'); ?></p>
        <?php include_partial('global/errorMessages', array('form' => $form_expl)); ?>
        <?php include_partial('global/errorMessages', array('form' => $form_gest)); ?>
        <div id="infos_exploitation" class="<?php if ($form_expl_err) echo 'edition'; ?>">

            <h2 class="titre_section">Exploitation <a href="" class="msg_aide" rel="help_popup_exploitation_administratif_exploitation" title="Message aide"></a></h2>

            <div class="contenu_section">
                <div class="presentation clearfix"<?php if ($form_expl_err)
                         echo ' style="display:none;"'; ?>>
                    <div class="col_1">
                        <p class="num"><span>N° CVI :</span> <?php echo $tiers->cvi ?></p>
                        <p class="num">
                            <span>N° SIRET :</span>
                            <span id="siret_msg_aide">
                                <a href="" class="msg_aide" rel="help_popup_exploitation_administratif_siret" title="Message aide"></a>
                            </span>
                            <?php echo $tiers->siret ?>
                        </p>
                    </div>

                    <div class="col_2 bloc_gris">
                        <h3><?php echo $tiers->intitule; ?> <?php echo $tiers->nom ?></h3>
                        <address>
                            <?php echo $tiers->siege->adresse ?><br />
                            <?php echo $tiers->siege->getCodePostal(); ?> <?php echo $tiers->siege->commune ?>
                        </address>

                        <p><span>Téléphone :</span> <?php echo formatPhone($tiers->telephone); ?></p>
                        <p><span>Fax :</span> <?php echo formatPhone($tiers->fax); ?></p>
                    </div>
                    <div class="btn">
                        <a href="#" class="modifier"><img src="/images/boutons/btn_modifier_infos.png" alt="Modifier les informations" /></a>
                    </div>
                </div>


                <div class="modification clearfix"<?php if (!$form_expl_err)
                         echo ' style="display:none;"'; ?>>
                    <p class="message">Ces modifications sont prises en compte sous réserves de validation par le service des douanes.</p>

                    <form method="POST" action="<?php echo url_for('dr_exploitation', array('sf_subject' => $dr, 'exploitation' => 1)); ?>">

                        <?php echo $form_expl->renderHiddenFields(); ?>
                        <div class="col_1">
                            <?php $name = 'siret'; ?>
                            <div class="bloc_vert ligne_form <?php echo ($form_expl[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl[$name]->renderLabel();  ?>
                                <?php echo $form_expl[$name]->render(); ?>
                            </div>

                        </div>

                        <div class="col_2 bloc_gris">
                            <?php $name = 'intitule'; ?>
                            <div class="ligne_form <?php echo ($form_expl[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl[$name]->renderLabel(); ?>
                                <?php echo $form_expl[$name]->render(); ?>
                            </div>
                            <?php $name = 'nom'; ?>
                            <div class="ligne_form <?php echo ($form_expl[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl[$name]->renderLabel(); ?>
                                <?php echo $form_expl[$name]->render(); ?>
                            </div>
                            <?php $name = 'adresse'; ?>
                            <div class="ligne_form <?php echo ($form_expl['siege'][$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl['siege'][$name]->renderLabel(); ?>
                                <?php echo $form_expl['siege'][$name]->render(); ?>
                            </div>
                            <?php $name = 'code_postal'; ?>
                            <div class="ligne_form <?php echo ($form_expl['siege'][$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl['siege'][$name]->renderLabel(); ?>
                                <?php echo $form_expl['siege'][$name]->render(); ?>
                            </div>
                            <?php $name = 'commune'; ?>
                            <div class="ligne_form <?php echo ($form_expl['siege'][$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl['siege'][$name]->renderLabel(); ?>
                                <?php echo $form_expl['siege'][$name]->render(); ?>
                            </div>
                            <?php $name = 'telephone'; ?>
                            <div class="ligne_form <?php echo ($form_expl[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl[$name]->renderLabel(); ?>
                                <?php echo $form_expl[$name]->render(); ?>
                            </div>
                            <?php $name = 'fax'; ?>
                            <div class="ligne_form <?php echo ($form_expl[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                                <?php echo $form_expl[$name]->renderLabel(); ?>
                                <?php echo $form_expl[$name]->render(); ?>
                            </div>
                        </div>


                        <div class="btn">
                            <a href="<?php echo url_for('dr_exploitation', $dr) ?>" tabindex="-1" class="annuler"><img src="/images/boutons/btn_annuler.png" alt="Annuler" /></a>

                            <input type="image" src="/images/boutons/btn_valider.png" alt="Valider" />
                        </div>


                </div>

                </form>
            </div>
        </div>

        <div id="gestionnaire_exploitation" class="<?php if ($form_gest_err) echo 'edition'; ?>">
            <h2 class="titre_section">Gestionnaire de l'exploitation <a href="" class="msg_aide" rel="help_popup_exploitation_administratif_gestionnaire" title="Message aide"></a></h2>
            <div class="contenu_section">
                <div class="bloc_gris presentation"<?php if ($form_gest_err)
                         echo ' style="display:none;"'; ?>>
                    <h3><?php echo $tiers->exploitant->nom ?></h3>
                    <address>
                        <?php echo $tiers->exploitant->adresse ?><br />
                        <?php echo $tiers->exploitant->getCodePostal(); ?> <?php echo $tiers->exploitant->commune ?>
                    </address>

                    <p><span>Téléphone :</span> <?php echo preg_replace('/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/', '\1.\2.\3.\4.\5', $tiers->exploitant->telephone); ?></p>
                    <p><span>Date de naissance :</span> <?php echo $tiers->exploitant->getDateNaissanceFr(); ?></p>
                    <div class="btn">
                        <a class="modifier" href="#"><img alt="Modifier les informations" src="/images/boutons/btn_modifier_infos.png"></a>
                    </div>
                </div>
                <div class="bloc_gris modification"<?php if (!$form_gest_err)
                         echo ' style="display:none;"'; ?>>
                    <form method="POST" action="<?php echo url_for('dr_exploitation', array('sf_subject' => $dr, 'gestionnaire' => 1)); ?>">
                        <?php echo $form_gest->renderHiddenFields(); ?>
                        <?php $name = 'nom'; ?>
                        <div class="ligne_form <?php echo ($form_gest[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                            <?php echo $form_gest[$name]->renderLabel(); ?>
                            <?php echo $form_gest[$name]->render(); ?>
                        </div>
                        <?php $name = 'adresse'; ?>
                        <div class="ligne_form <?php echo ($form_gest[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                            <?php echo $form_gest[$name]->renderLabel(); ?>
                            <?php echo $form_gest[$name]->render(); ?>
                        </div>
                        <?php $name = 'code_postal'; ?>
                        <div class="ligne_form <?php echo ($form_gest[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                            <?php echo $form_gest[$name]->renderLabel(); ?>
                            <?php echo $form_gest[$name]->render(); ?>
                        </div>
                        <?php $name = 'commune'; ?>
                        <div class="ligne_form <?php echo ($form_gest[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                            <?php echo $form_gest[$name]->renderLabel(); ?>
                            <?php echo $form_gest[$name]->render(); ?>

                        </div>
                        <?php $name = 'telephone'; ?>
                        <div class="ligne_form <?php echo ($form_gest[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                            <?php echo $form_gest[$name]->renderLabel(); ?>
                            <?php echo $form_gest[$name]->render(); ?>

                        </div>
                        <?php $name = 'date_naissance'; ?>
                        <div class="ligne_form <?php echo ($form_gest[$name]->hasError()) ? sfConfig::get('app_css_class_field_error') : null ?>">
                            <?php echo $form_gest[$name]->renderLabel(); ?>
                            <?php echo $form_gest[$name]->render(); ?>
                        </div>
                        <div class="btn">
                            <a class="annuler" tabindex="-1" href="<?php echo url_for('dr_exploitation', $dr); ?>"><img alt="Annuler" src="/images/boutons/btn_annuler.png"></a>
                            <input type="image" alt="Valider" src="/images/boutons/btn_valider.png">
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
    <!-- fin #exploitation_administratif -->
</div>
<!-- fin #application_dr -->

<form id="principal" action="<?php echo url_for('dr_exploitation', $dr); ?>" method="post">
    <?php include_partial('dr/boutons', array('display' => array('precedent', 'suivant'), 'dr' => $dr)) ?>
</form>
<!-- fin #principal -->
