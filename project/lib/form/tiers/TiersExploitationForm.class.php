<?php

class TiersExploitationForm extends acCouchdbObjectForm {

    public function configure() {
        $intitules = array(''=>"");
        foreach(sfConfig::get('app_configuration_compte_intitules') as $intitule) {
            $intitules[$intitule] = $intitule;
        }

        $this->setWidgets(array(
				'intitule' =>  new sfWidgetFormChoice(array(
									    'choices' => $intitules, 'label' => 'Intitulé'
									    )),
				'siret' => new sfWidgetFormInputText(array('label' => "N° de SIRET")),
				'nom' => new sfWidgetFormInputText(array('label' => "Nom de l'exploitation")),
				'telephone' => new sfWidgetFormInputText(array('label' => 'Téléphone')),
				'fax' => new sfWidgetFormInputText(array('label' => 'Fax')),

				));
	$faxTelValidator = new sfValidatorRegex(array('pattern' => '/^\d{10}$/','required' => false, 'max_length' => 10, 'min_length' => 10),
                                                                                    array('max_length' => 'Le numéro doit être formatté avec 10 chiffres',
                                                                                          'min_length' => 'Le numéro doit être formaté avec 10 chiffres',
                                                                                            'invalid' => 'Ne doit contenir que des chiffres'));

        $this->setValidators(array(
				   'nom' => new sfValidatorString(array('required' => true), array('required' => 'Champ Requis')),
				   'siret' => new sfValidatorRegex(array('pattern' => '/^\d+$/', 'required' => false), array('invalid' => 'Ne doit contenir que des chiffres', 'required' => 'Champ Requis')),
				   'telephone' => $faxTelValidator,
                                   'fax' => $faxTelValidator,
                                   'intitule' => new sfValidatorString(array('required' => false))

				   ));

        if(!$this->getObject()->exist('siret')) {
            unset($this->widgetSchema['siret']);
            unset($this->validatorSchema['siret']);
        }

	$this->siege = new TiersSiegeForm($this->getObject()->getSiege());
	$this->embedForm('siege', $this->siege);

        $this->widgetSchema->setNameFormat('exploitatation[%s]');
        $this->errorSchema = new sfValidatorErrorSchema($this->validatorSchema);
    }

}
