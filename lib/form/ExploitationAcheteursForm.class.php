<?php

class ExploitationAcheteursForm extends sfCouchdbFormDocumentJson {

    public static $config_appellations = null;
    public static $config_appellations_mout = null;
    const FORM_NAME_NEGOCES = 'negoces';
    const FORM_NAME_COOPERATIVES = 'cooperatives';
    const FORM_NAME_MOUTS = 'mouts';
    const FORM_NAME_CAVE_PARTICULIERE = 'cave_particuliere';
    const FORM_SUFFIX_NEW = '_new';
    const FORM_NAME = 'exploitation_acheteurs[%s]';

    public function configure() {
        $this->configureMultipleItem(self::FORM_NAME_NEGOCES, $this->getObject()->getArrayNegocesWithAppellation(), self::getListeAppellations());
        $this->configureMultipleItem(self::FORM_NAME_COOPERATIVES, $this->getObject()->getArrayCooperativesWithAppellation(), self::getListeAppellations());
        $this->configureMultipleItem(self::FORM_NAME_MOUTS, $this->getObject()->getArrayMoutsWithAppellation(), self::getListeAppellationsMout());
        $this->configureSingleItem(self::FORM_NAME_CAVE_PARTICULIERE, $this->getObject()->getArrayCaveParticuliereWithAppellation(), self::getListeAppellations());

        $this->widgetSchema->setNameFormat(self::FORM_NAME);
        $this->errorSchema = new sfValidatorErrorSchema($this->validatorSchema);
    }

    public function bind(array $taintedValues = null, array $taintedFiles = null) {
        $this->bindCheckDelete(self::FORM_NAME_NEGOCES, $taintedValues);
        $this->configureMultipleItemFromBind(self::FORM_NAME_NEGOCES . self::FORM_SUFFIX_NEW, $taintedValues, self::getListeAppellations());

        $this->bindCheckDelete(self::FORM_NAME_COOPERATIVES, $taintedValues);
        $this->configureMultipleItemFromBind(self::FORM_NAME_COOPERATIVES . self::FORM_SUFFIX_NEW, $taintedValues, self::getListeAppellations());

        $this->bindCheckDelete(self::FORM_NAME_MOUTS, $taintedValues);
        $this->configureMultipleItemFromBind(self::FORM_NAME_MOUTS . self::FORM_SUFFIX_NEW, $taintedValues, self::getListeAppellationsMout());

        parent::bind($taintedValues, $taintedFiles);
    }

    protected function configureMultipleItemFromBind($name, $taintedValues, $appellations) {
        if (isset($taintedValues[$name])) {
            $this->configureMultipleItem($name, $taintedValues[$name], $appellations);
        }
    }

    protected function configureMultipleItem($name, $values, $appellations) {
        $form = new BaseForm();
        foreach ($values as $acheteur_cvi => $acheteur_appellations) {
            $form->embedForm($acheteur_cvi, new ExploitationAcheteursItemForm(array_merge(array('cvi' => $acheteur_cvi), $acheteur_appellations), array('appellations' => $appellations)));
        }
        $this->embedForm($name, $form);
    }

    protected function configureSingleItem($name, $values, $appellations) {
        $this->embedForm($name, new ExploitationAcheteursItemForm($values, array('appellations' => $appellations, 'cvi_required' => false)));
    }

    protected function bindCheckDelete($name, $taintedValues) {
        foreach ($this->embeddedForms[$name] as $cvi => $form) {
            if (!isset($taintedValues[$name][$cvi])) {
                unset($this->widgetSchema[$name][$cvi]);
            }
        }
    }

    public function doUpdateObject($values) {
        foreach ($this->getObject() as $key => $item) {
            $this->getObject()->remove($key);
        }

        $this->updateMultipleItem(self::FORM_NAME_NEGOCES, self::FORM_NAME_NEGOCES, $values, self::getListeAppellations());
        $this->updateMultipleItem(self::FORM_NAME_NEGOCES . self::FORM_SUFFIX_NEW, self::FORM_NAME_NEGOCES, $values, self::getListeAppellations());

        $this->updateMultipleItem(self::FORM_NAME_COOPERATIVES, self::FORM_NAME_COOPERATIVES, $values, self::getListeAppellations());
        $this->updateMultipleItem(self::FORM_NAME_COOPERATIVES . self::FORM_SUFFIX_NEW, self::FORM_NAME_COOPERATIVES, $values, self::getListeAppellations());

        $this->updateMultipleItem(self::FORM_NAME_MOUTS, self::FORM_NAME_MOUTS, $values, self::getListeAppellationsMout());
        $this->updateMultipleItem(self::FORM_NAME_MOUTS . self::FORM_SUFFIX_NEW, self::FORM_NAME_MOUTS, $values, self::getListeAppellationsMout());

        $this->updateSingleItem(self::FORM_NAME_CAVE_PARTICULIERE, $values, self::getListeAppellations());
    }

    protected function updateMultipleItem($value_name, $name, $values, $config_appellations) {
        if (isset($values[$value_name])) {
            foreach ($values[$value_name] as $cvi => $appellations) {
                unset($appellations['cvi']);
                foreach ($appellations as $appellation_key => $appellation) {
                    if (isset($config_appellations[$appellation_key])) {
                        if ($appellation == true) {
                            $this->getObject()->add('appellation_' . $config_appellations[$appellation_key]->appellation)->get($name)->add(null, $cvi);
                        }
                    }
                }
            }
        }
    }

    protected function updateSingleItem($name, $values, $config_appellations) {
        if (isset($values[$name])) {
            unset($values['cvi']);
            foreach ($values[$name] as $appellation_key => $appellation) {
                if (isset($config_appellations[$appellation_key])) {
                    if ($appellation == true) {
                        $this->getObject()->add($appellation_key)->set($name, 1);
                    }
                }
            }
        }
    }

    public function updateObjectEmbeddedForms($values, $forms = null) {
        
    }

    public static function getNewItemAjax($name, $cvi, $values, $appellations) {
        $form_container = new BaseForm();
        $form_container->getWidgetSchema()->setNameFormat(self::FORM_NAME);
        $form = new BaseForm();
        $form->embedForm($cvi, new ExploitationAcheteursItemForm(array_merge(array('cvi' => $cvi), $values), array('appellations' => $appellations)));
        $form_container->embedForm($name . self::FORM_SUFFIX_NEW, $form);
        return $form_container;
    }

    public static function getListeAppellations() {
        if (self::$config_appellations == null) {
            $configuration = ConfigurationClient::getConfiguration();
            return self::$config_appellations = $configuration->getArrayAppellations();
        }

        return self::$config_appellations;
    }

    public static function getListeAppellationsMout() {
        if (self::$config_appellations_mout == null) {
            $configuration = ConfigurationClient::getConfiguration();
            return self::$config_appellations_mout = $configuration->getArrayAppellationsMout();
        }

        return self::$config_appellations_mout;
    }

}